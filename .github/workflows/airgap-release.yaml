name: Airgap Release Build

on:
  workflow_dispatch:
    inputs:
      upload_r2:
        description: 'Upload to Cloudflare R2'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
  push:
    tags:
      - 'v*'

env:
  HAULER_VERSION: "1.3.0"

jobs:
  # Build core products (K3s, ESS, Helm)
  build-core-products:
    name: Build Core Products
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        product:
          - name: k3s
            script: hauler/scripts/k3s/hauler-k3s.sh
            manifest: hauler/k3s/rancher-airgap-k3s.yaml
            version_var: vK3S
          - name: ess-helm
            script: hauler/scripts/ess-helm/hauler-ess-helm.sh
            manifest: hauler/ess-helm/rancher-airgap-ess-helm.yaml
            version_var: vESSHelmChart
          - name: helm
            script: hauler/scripts/helm/hauler-helm.sh
            manifest: hauler/helm/rancher-airgap-helm.yaml
            version_var: vHelm
        arch:
          - linux/amd64
          - linux/arm64
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Hauler
        run: |
          curl -sfL https://get.hauler.dev | bash
          hauler version

      - name: Extract Version
        id: version
        run: |
          VERSION=$(grep "export ${{ matrix.product.version_var }}=" ${{ matrix.product.script }} | head -1 | cut -d'=' -f2)
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Product version: ${VERSION}"

      - name: Build Hauler Store
        run: |
          cd $(dirname ${{ matrix.product.manifest }})
          ARCH_NAME=$(echo "${{ matrix.arch }}" | tr '/' '-')
          hauler store sync \
            --store ${ARCH_NAME}-store \
            --platform ${{ matrix.arch }} \
            --filename $(basename ${{ matrix.product.manifest }})
          hauler store info --store ${ARCH_NAME}-store

      - name: Save Hauler Store
        run: |
          cd $(dirname ${{ matrix.product.manifest }})
          ARCH_NAME=$(echo "${{ matrix.arch }}" | tr '/' '-')
          ARCH_SHORT=$(echo "${{ matrix.arch }}" | cut -d'/' -f2)
          hauler store save \
            --store ${ARCH_NAME}-store \
            --filename ${{ matrix.product.name }}-${{ steps.version.outputs.version }}-${ARCH_SHORT}.tar.zst

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.product.name }}-${{ steps.version.outputs.version }}-${{ matrix.arch == 'linux/amd64' && 'amd64' || 'arm64' }}
          path: hauler/${{ matrix.product.name }}/*.tar.zst
          retention-days: 7

  # Build legacy Rancher products
  build-rancher-products:
    name: Build Rancher Products
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        product:
          - name: rke2
            script: hauler/scripts/rke2/hauler-rke2.sh
            manifest: hauler/rke2/rancher-airgap-rke2.yaml
            version_var: vRKE2
          - name: rancher
            script: hauler/scripts/rancher/hauler-rancher.sh
            manifest: hauler/rancher/rancher-airgap-rancher.yaml
            version_var: vRancher
          - name: longhorn
            script: hauler/scripts/longhorn/hauler-longhorn.sh
            manifest: hauler/longhorn/rancher-airgap-longhorn.yaml
            version_var: vLonghorn
          - name: neuvector
            script: hauler/scripts/neuvector/hauler-neuvector.sh
            manifest: hauler/neuvector/rancher-airgap-neuvector.yaml
            version_var: vNeuVector
        arch:
          - linux/amd64
          - linux/arm64
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Hauler
        run: |
          curl -sfL https://get.hauler.dev | bash
          hauler version

      - name: Extract Version
        id: version
        run: |
          VERSION=$(grep "export ${{ matrix.product.version_var }}=" ${{ matrix.product.script }} | head -1 | cut -d'=' -f2)
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Product version: ${VERSION}"

      - name: Build Hauler Store
        run: |
          cd $(dirname ${{ matrix.product.manifest }})
          ARCH_NAME=$(echo "${{ matrix.arch }}" | tr '/' '-')
          hauler store sync \
            --store ${ARCH_NAME}-store \
            --platform ${{ matrix.arch }} \
            --filename $(basename ${{ matrix.product.manifest }})
          hauler store info --store ${ARCH_NAME}-store

      - name: Save Hauler Store
        run: |
          cd $(dirname ${{ matrix.product.manifest }})
          ARCH_NAME=$(echo "${{ matrix.arch }}" | tr '/' '-')
          ARCH_SHORT=$(echo "${{ matrix.arch }}" | cut -d'/' -f2)
          hauler store save \
            --store ${ARCH_NAME}-store \
            --filename ${{ matrix.product.name }}-${{ steps.version.outputs.version }}-${ARCH_SHORT}.tar.zst

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.product.name }}-${{ steps.version.outputs.version }}-${{ matrix.arch == 'linux/amd64' && 'amd64' || 'arm64' }}
          path: hauler/${{ matrix.product.name }}/*.tar.zst
          retention-days: 7

  # Build OS-specific dependency tarballs
  build-os-dependencies:
    name: Build OS Dependencies
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        os:
          - name: linux
            packages: iptables container-selinux libnetfilter_conntrack libnfnetlink libnftnl policycoreutils-python-utils cryptsetup nfs-utils iscsi-initiator-utils git zip zstd tree jq createrepo
          - name: windows-wsl2
            packages: iptables container-selinux git zip zstd tree jq
          - name: macos
            packages: git zip zstd tree jq
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y createrepo-c yum-utils

      - name: Setup Working Directory
        run: |
          mkdir -p /tmp/hauler/repos/${{ matrix.os.name }}
          cd /tmp/hauler/repos/${{ matrix.os.name }}

      - name: Download Required Packages
        if: matrix.os.name == 'linux'
        run: |
          cd /tmp/hauler/repos/${{ matrix.os.name }}
          # Use yumdownloader instead of repotrack for GitHub Actions environment
          for pkg in ${{ matrix.os.packages }}; do
            yumdownloader --resolve --destdir=. $pkg || true
          done

      - name: Create YUM Repo
        if: matrix.os.name == 'linux'
        run: |
          cd /tmp/hauler/repos/${{ matrix.os.name }}
          createrepo_c .

      - name: Create Package List
        run: |
          cd /tmp/hauler/repos/${{ matrix.os.name }}
          find . -type f > package-list.txt

      - name: Create OS Dependencies Tarball
        run: |
          cd /tmp/hauler/repos
          tar czf ${{ matrix.os.name }}-dependencies-${{ github.ref_name || 'latest' }}.tar.gz ${{ matrix.os.name }}/
          ls -lh *.tar.gz

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os.name }}-dependencies
          path: /tmp/hauler/repos/*.tar.gz
          retention-days: 7

  # Create GitHub Release and upload all artifacts
  create-release:
    name: Create GitHub Release
    needs: [build-core-products, build-rancher-products, build-os-dependencies]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: List Downloaded Artifacts
        run: |
          find artifacts/ -type f
          du -sh artifacts/*

      - name: Create Release Notes
        run: |
          cat > RELEASE-NOTES.md << 'EOF'
          # Airgap Release ${{ github.ref_name }}
          
          This release contains airgapped image stores and OS dependencies for deploying K3s, Element Server Suite (ESS), and other Rancher products in disconnected environments.
          
          ## What's Included
          
          ### Core Products
          - **K3s**: Lightweight Kubernetes for airgap deployments
          - **Element Server Suite (ESS)**: Complete Matrix communication stack
          - **Helm**: Package manager for Kubernetes
          
          ### Legacy Rancher Products
          - **RKE2**: Rancher Kubernetes Engine 2
          - **Rancher**: Multi-Cluster Manager
          - **Longhorn**: Cloud-native distributed storage
          - **NeuVector**: Container security platform
          
          ### OS Dependencies
          - **Linux**: Full dependency packages for RHEL/CentOS-based systems
          - **Windows WSL2**: Dependencies for running K3s in WSL2
          - **macOS**: Dependencies for running K3s via Docker Desktop/Rancher Desktop
          
          ## Platform Support
          
          All image stores are available for both `amd64` and `arm64` architectures.
          
          ## Usage
          
          Refer to the [K3s + ESS Quickstart Guide](https://github.com/hanthor/rancher-airgap/blob/main/examples/k3s-ess-quickstart.md) for deployment instructions.
          
          ## Installation
          
          1. Download the appropriate image store tarball for your architecture
          2. Download the OS dependencies tarball for your platform
          3. Transfer files across the airgap
          4. Follow the quickstart guide to load and deploy
          
          ---
          
          Release automatically generated by GitHub Actions on $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          EOF
          cat RELEASE-NOTES.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: RELEASE-NOTES.md
          draft: false
          prerelease: false
          files: |
            artifacts/**/*.tar.zst
            artifacts/**/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Optional: Upload to Cloudflare R2
  upload-to-r2:
    name: Upload to Cloudflare R2
    needs: [build-core-products, build-rancher-products, build-os-dependencies]
    runs-on: ubuntu-latest
    permissions:
      contents: read
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.upload_r2 == 'true') ||
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/'))
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Configure R2 Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: auto
          aws-access-key-id: ${{ secrets.R2_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY }}

      - name: Upload to Cloudflare R2
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          # Install AWS CLI if not present
          if ! command -v aws &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y awscli
          fi
          
          # Upload all artifacts to R2
          RELEASE_TAG="${{ github.ref_name }}"
          if [ -z "$RELEASE_TAG" ]; then
            RELEASE_TAG="latest"
          fi
          
          find artifacts/ -type f \( -name "*.tar.zst" -o -name "*.tar.gz" \) | while read file; do
            filename=$(basename "$file")
            echo "Uploading $filename to R2..."
            aws s3 cp "$file" "s3://${R2_BUCKET}/${RELEASE_TAG}/${filename}" \
              --endpoint-url "${R2_ENDPOINT}" \
              --no-progress
          done
          
          echo "All files uploaded to R2 bucket: ${R2_BUCKET}/${RELEASE_TAG}/"
