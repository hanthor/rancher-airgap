name: Local Airgap Test for K3s + ESS

on:
  workflow_dispatch:
  push:
    branches:
      - main

env:
  HAULER_VERSION: 1.3.1
  K3S_VERSION: v1.33.5+k3s1
  HELM_VERSION: v3.19.0
  ESS_CHART_VERSION: 25.11.0
  DOMAIN: ess.local
  PLATFORM: ${{ runner.arch }}

jobs:
  airgap-test:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up environment variables
        run: |
          echo "HAULER_VERSION=${HAULER_VERSION}" >> $GITHUB_ENV
          echo "K3S_VERSION=${K3S_VERSION}" >> $GITHUB_ENV
          echo "HELM_VERSION=${HELM_VERSION}" >> $GITHUB_ENV
          echo "ESS_CHART_VERSION=${ESS_CHART_VERSION}" >> $GITHUB_ENV
          echo "DOMAIN=${DOMAIN}" >> $GITHUB_ENV
          echo "PLATFORM=${PLATFORM}" >> $GITHUB_ENV

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq

      - name: Source airgap-lib.sh and hauler-functions.sh
        run: |
          set -euo pipefail
          SCRIPT_DIR="${GITHUB_WORKSPACE}/.github/workflows"
          REPO_ROOT="${GITHUB_WORKSPACE}"
          CONFIG_DIR="$REPO_ROOT/.github/workflows/config"
          source "$SCRIPT_DIR/airgap-lib.sh"
          source "$SCRIPT_DIR/hauler-functions.sh"

      - name: Run Local Airgap Test
        run: |
          set -euo pipefail
          SCRIPT_DIR="${GITHUB_WORKSPACE}/.github/workflows"
          REPO_ROOT="${GITHUB_WORKSPACE}"
          CONFIG_DIR="$REPO_ROOT/.github/workflows/config"
          WORK_DIR="/tmp/airgap-test"
          LOG_DIR="$WORK_DIR/logs"
          K3S_REGISTRY_PORT=5001
          ESS_REGISTRY_PORT=5002
          K3S_FILESERVER_PORT=8080
          HELM_FILESERVER_PORT=8081
          ARCH=$(detect_architecture "${PLATFORM}")

          # Setup directories
          setup_directories "$WORK_DIR" "$LOG_DIR"

          # Install Hauler
          install_hauler "$HAULER_VERSION" "$ARCH"

          # Build Hauler stores
          build_all_hauler_stores "$REPO_ROOT" "$ARCH" "$LOG_DIR"

          # Configure K3s registries
          configure_k3s_registries "$CONFIG_DIR/k3s-registries.yaml" "$K3S_REGISTRY_PORT" "$ESS_REGISTRY_PORT"

          # Install K3s
          install_k3s_from_hauler "$REPO_ROOT" "$K3S_VERSION" "$ARCH" "$WORK_DIR" "$LOG_DIR" "$K3S_FILESERVER_PORT"

          # Start Hauler services
          start_hauler_services

          # Install Helm
          install_helm_from_hauler "$HELM_VERSION" "$ARCH" "$HELM_FILESERVER_PORT"

          # Deploy ESS
          deploy_ess "$DOMAIN" "$ESS_CHART_VERSION" "$ESS_REGISTRY_PORT" "$CONFIG_DIR" "$LOG_DIR" "$REPO_ROOT"

          # Validate deployment
          validate_ess_deployment "$DOMAIN" "$K3S_VERSION" "$ESS_CHART_VERSION" "$ARCH"
